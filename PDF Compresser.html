<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Сжиматель (Dark Mode)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #334155;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center font-sans text-slate-200">
    <div class="w-full max-w-lg bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 m-4 relative overflow-hidden">
<div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
<div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-slate-700/50 text-blue-400 mb-4 ring-1 ring-slate-600 shadow-lg">
                <i data-lucide="file-down" class="w-7 h-7"></i>
            </div>
            <h1 class="text-2xl font-bold text-white tracking-tight">Сжатие PDF</h1>
            <p class="text-slate-400 text-sm mt-2">Оптимизация размера через Canvas</p>
        </div>
<div class="mb-8">
            <label class="block text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider text-xs">1. Загрузите файл</label>
            <div class="relative group">
                <input type="file" id="pdfInput" accept=".pdf" class="hidden" onchange="handleFileSelect(event)">
                <label for="pdfInput" class="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-slate-600 rounded-xl cursor-pointer hover:bg-slate-700/50 hover:border-blue-500 transition-all duration-300 bg-slate-800 group-hover:shadow-lg group-hover:shadow-blue-500/10" id="dropZone">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4">
                        <div id="iconContainer" class="p-3 bg-slate-700 rounded-full mb-3 group-hover:bg-slate-600 transition-colors">
                            <i data-lucide="upload-cloud" class="w-6 h-6 text-slate-400 group-hover:text-blue-400 transition-colors" id="uploadIcon"></i>
                        </div>
                        <p class="text-sm text-slate-300 mb-1 font-medium" id="fileName">Нажмите для выбора файла</p>
                        <p class="text-xs text-slate-500" id="fileSize">PDF до 50MB</p>
                    </div>
                </label>
            </div>
        </div>
<div class="mb-8 opacity-50 pointer-events-none transition-all duration-300 filter blur-[1px]" id="controlsArea">
            <div class="flex justify-between items-end mb-4">
                <label class="block text-sm font-medium text-slate-400 uppercase tracking-wider text-xs">2. Степень сжатия</label>
                <span class="text-sm font-bold text-blue-400 bg-blue-500/10 px-3 py-1 rounded border border-blue-500/20" id="qualityValue">50%</span>
            </div>
            
            <div class="relative py-2">
                <input type="range" min="0" max="100" value="50" class="w-full bg-transparent appearance-none cursor-pointer z-20 relative" id="compressionRange" oninput="updateQualityDisplay(this.value)">
            </div>
            
            <div class="flex justify-between text-[10px] uppercase font-bold text-slate-500 mt-2 tracking-wide">
                <span>Лучшее качество</span>
                <span>Макс. сжатие</span>
            </div>
            <p class="text-xs text-amber-400 mt-3 flex items-center gap-2 hidden bg-amber-900/20 p-2 rounded border border-amber-500/20" id="warningHighCompression">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i> 
                <span>Текст может стать нечетким</span>
            </p>
        </div>
<button id="compressBtn" onclick="startCompression()" disabled class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 px-4 rounded-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:grayscale flex items-center justify-center gap-2 shadow-lg shadow-blue-900/40 transform active:scale-[0.98]">
            <i data-lucide="shrink" class="w-5 h-5"></i>
            <span>ЗАПУСТИТЬ СЖАТИЕ</span>
        </button>
<div id="statusContainer" class="hidden mt-8 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
            <div class="flex justify-between text-xs text-slate-400 mb-2 font-mono">
                <span id="statusText">Инициализация...</span>
                <span id="progressPercent" class="text-blue-400">0%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 0%"></div>
            </div>
        </div>
<canvas id="renderCanvas" class="hidden"></canvas>

    </div>
    
    <div class="fixed bottom-4 text-slate-600 text-xs text-center w-full pointer-events-none">
        Обработка происходит локально в браузере
    </div>

    <script>
        lucide.createIcons();

        let currentFile = null;
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === "application/pdf") {
                currentFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileName').classList.add('text-blue-300');
                
                document.getElementById('fileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                const uploadIcon = document.getElementById('uploadIcon');
                uploadIcon.classList.remove('text-slate-400', 'group-hover:text-blue-400');
                uploadIcon.classList.add('text-blue-400');
                
                document.getElementById('iconContainer').classList.add('bg-blue-500/20');
                
                const dropZone = document.getElementById('dropZone');
                dropZone.classList.add('border-blue-500', 'bg-blue-500/5');
                dropZone.classList.remove('border-slate-600');
                const controls = document.getElementById('controlsArea');
                controls.classList.remove('opacity-50', 'pointer-events-none', 'blur-[1px]');
                
                const btn = document.getElementById('compressBtn');
                btn.disabled = false;
                btn.classList.remove('grayscale');
            } else {
                alert("Пожалуйста, выберите корректный PDF файл.");
            }
        }
        function updateQualityDisplay(val) {
            document.getElementById('qualityValue').textContent = val + '%';
            
            const warning = document.getElementById('warningHighCompression');
            if (val > 80) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }
        async function startCompression() {
            if (!currentFile) return;

            const btn = document.getElementById('compressBtn');
            const statusContainer = document.getElementById('statusContainer');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const progressPercent = document.getElementById('progressPercent');
            const canvas = document.getElementById('renderCanvas');
            const ctx = canvas.getContext('2d');
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Обработка...`;
            statusContainer.classList.remove('hidden');

            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                const { jsPDF } = window.jspdf;
                let newPdf = null; 

                const sliderVal = parseInt(document.getElementById('compressionRange').value);
                let quality = 0.9 - (sliderVal / 100) * 0.8;
                quality = Math.max(0.1, Math.min(0.9, quality));
                
                let scale = 1.5; 
                if (sliderVal > 75) scale = 1.0; 

                const totalPages = pdf.numPages;

                for (let i = 1; i <= totalPages; i++) {
                    const percent = Math.round(((i - 1) / totalPages) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressPercent.textContent = `${percent}%`;
                    statusText.textContent = `Страница ${i} из ${totalPages}...`;
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: scale });

                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;

                    const imgData = canvas.toDataURL('image/jpeg', quality);
                    const isPortrait = viewport.width < viewport.height;
                    const orientation = isPortrait ? 'p' : 'l';
                    
                    if (i === 1) {
                        newPdf = new jsPDF({
                            orientation: orientation,
                            unit: 'px',
                            format: [viewport.width, viewport.height] 
                        });
                    } else {
                        newPdf.addPage([viewport.width, viewport.height], orientation);
                    }

                    newPdf.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height, null, 'FAST');
                    
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                progressBar.style.width = `100%`;
                progressPercent.textContent = `100%`;
                statusText.textContent = `Сохранение файла...`;
                statusText.classList.add('text-green-400');

                const originalName = currentFile.name;
                const dotIndex = originalName.lastIndexOf('.');
                const nameBase = dotIndex !== -1 ? originalName.substring(0, dotIndex) : originalName;
                const newName = `${nameBase} [compressed].pdf`;

                newPdf.save(newName);

                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('from-blue-600', 'to-indigo-600');
                    btn.classList.add('bg-green-600', 'hover:bg-green-500');
                    btn.innerHTML = `<i data-lucide="check" class="w-5 h-5 mr-2"></i> Готово`;
                    
                    setTimeout(() => {
                         btn.classList.remove('bg-green-600', 'hover:bg-green-500');
                         btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600');
                         btn.innerHTML = `<i data-lucide="shrink" class="w-5 h-5 mr-2"></i> ЗАПУСТИТЬ СЖАТИЕ`;
                         statusContainer.classList.add('hidden');
                         lucide.createIcons();
                    }, 3000);
                }, 1000);

            } catch (error) {
                console.error(error);
                alert("Ошибка: " + error.message);
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="shrink" class="w-5 h-5 mr-2"></i> ЗАПУСТИТЬ СЖАТИЕ`;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>
