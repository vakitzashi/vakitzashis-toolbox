<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lurker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #0b0f14;
      --bg-panel: #121821;
      --bg-panel-2: #0f141c;
      --border: #1f2a36;
      --accent: #2ec4b6;
      --accent-soft: rgba(46,196,182,0.15);
      --text-main: #e6edf3;
      --text-dim: #8aa0b3;
      --danger: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(circle at 20% 20%, #0f1722, #070a0f 60%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
.app {
      width: 100%;
      max-width: 920px;
      background: linear-gradient(180deg, var(--bg-panel), var(--bg-panel-2));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow:
        0 20px 60px rgba(0,0,0,0.6),
        inset 0 0 0 1px rgba(255,255,255,0.03);
      overflow: hidden;
    }

    .header {
      padding: 28px 32px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(46,196,182,0.08), rgba(46,196,182,0.02));
    }

    .title {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.4px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .title-badge {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent-soft);
      border: 1px solid rgba(46,196,182,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-dim);
    }

    .content {
      padding: 24px 32px 32px;
      display: grid;
      gap: 18px;
    }
.card {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
    }

    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .upload-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid rgba(46,196,182,0.5);
      background: linear-gradient(180deg, rgba(46,196,182,0.25), rgba(46,196,182,0.12));
      color: var(--text-main);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: 0.18s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    .btn:hover {
      transform: translateY(-1px);
      background: linear-gradient(180deg, rgba(46,196,182,0.35), rgba(46,196,182,0.18));
      box-shadow: 0 10px 26px rgba(0,0,0,0.6);
    }

    .file-count {
      font-size: 13px;
      color: var(--text-dim);
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 14px 16px 14px 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #0c1118;
      color: var(--text-main);
      font-size: 15px;
      outline: none;
      transition: 0.18s ease;
    }

    .search-box input:focus {
      border-color: rgba(46,196,182,0.7);
      box-shadow: 0 0 0 3px rgba(46,196,182,0.15);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      color: var(--text-dim);
    }
.results {
      max-height: 420px;
      overflow-y: auto;
      display: grid;
      gap: 12px;
      padding-right: 4px;
    }

    .results::-webkit-scrollbar {
      width: 8px;
    }

    .results::-webkit-scrollbar-thumb {
      background: #1c2530;
      border-radius: 8px;
    }

    .result-item {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }

    .result-file {
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 6px;
      word-break: break-all;
    }

    .result-text {
      font-size: 14px;
      line-height: 1.5;
      color: #c9d6e2;
    }

    .highlight {
      background: rgba(255,107,107,0.18);
      color: #ffdede;
      padding: 1px 4px;
      border-radius: 6px;
      border: 1px solid rgba(255,107,107,0.35);
    }

    .empty {
      text-align: center;
      padding: 24px;
      font-size: 14px;
      color: var(--text-dim);
      border: 1px dashed var(--border);
      border-radius: 14px;
    }

    .ai-loading {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
    }

    .ai-loading::after {
      content: '';
      animation: dots 1.4s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .ai-result {
      margin-top: 14px;
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(46,196,182,0.08), rgba(46,196,182,0.02));
      border: 1px solid rgba(46,196,182,0.3);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-main);
    }

    .ai-result h3, .ai-result h4 {
      color: var(--accent);
      margin: 12px 0 6px 0;
      font-size: 13px;
      font-weight: 600;
    }

    .ai-result ul, .ai-result ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .ai-result li {
      margin: 4px 0;
      color: #c9d6e2;
    }

    .ai-result strong {
      color: var(--accent);
    }

    .ai-result em {
      color: var(--text-dim);
      font-style: italic;
    }

    .ai-error {
      color: var(--danger);
      background: linear-gradient(180deg, rgba(255,107,107,0.08), rgba(255,107,107,0.02));
      border-color: rgba(255,107,107,0.3);
    }

    @media (max-width: 640px) {
      .header, .content {
        padding: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1 class="title">
        <span class="title-badge">⚕</span>
        Поиск по PDF
      </h1>
      <div class="subtitle">Локальный поиск по базе анализов</div>
    </div>

    <div class="content">
      <div class="card">
        <div class="card-title">Файлы</div>
        <div class="upload-row">
          <label class="btn" for="pdf-upload">Загрузить PDF</label>
          <span class="file-count" id="file-count">Файлов: 0</span>
        </div>
        <input type="file" id="pdf-upload" accept=".pdf" multiple>
      </div>

      <div class="card">
        <div class="card-title">Поиск по ключам</div>
        <div class="search-box">
          <span class="search-icon">🔎</span>
          <input type="text" id="search-input" placeholder="Ключевое слово, диагноз, дата...">
        </div>
      </div>

      <div class="card">
        <div class="card-title">Умный поиск</div>
        <div class="search-box">
          <span class="search-icon">🧠</span>
          <input type="text" id="ai-search-input" placeholder="Задайте вопрос об ваших документах...">
        </div>
        <div style="margin-top: 12px; font-size: 12px; color: var(--text-dim);">
          <span id="ai-status"></span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Результаты</div>
        <div class="results" id="results">
          <div class="empty">Нет данных для отображения</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    const GROQ_API_KEY = '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';
    const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
    
    const pdfFiles = [];
    const resultsContainer = document.getElementById('results');
    const searchInput = document.getElementById('search-input');
    const aiSearchInput = document.getElementById('ai-search-input');
    const aiStatus = document.getElementById('ai-status');
    const fileCount = document.getElementById('file-count');

    document.getElementById('pdf-upload').addEventListener('change', async (event) => {
      const files = Array.from(event.target.files);
      for (const file of files) {
        const text = await extractTextFromPDF(file);
        pdfFiles.push({ name: file.name, text });
      }
      fileCount.textContent = `Файлов: ${pdfFiles.length}`;
      searchInput.dispatchEvent(new Event('input'));
    });

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim().toLowerCase();
      resultsContainer.innerHTML = '';

      if (!query) {
        resultsContainer.innerHTML = '<div class="empty">Введите запрос</div>';
        return;
      }

      let total = 0;

      pdfFiles.forEach(pdf => {
        const matches = findKeywordWithContext(pdf.text, query);
        if (matches.length > 0) {
          total += matches.length;
          const div = document.createElement('div');
          div.className = 'result-item';
          div.innerHTML = `
            <div class="result-file">${pdf.name}</div>
            <div class="result-text">
              ${matches.map(m => highlightKeyword(m, query)).join('<br><br>')}
            </div>
          `;
          resultsContainer.appendChild(div);
        }
      });

      if (total === 0) {
        resultsContainer.innerHTML = '<div class="empty">Совпадений не найдено</div>';
      }
    });

    aiSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performAISearch();
      }
    });

    async function performAISearch() {
      const query = aiSearchInput.value.trim();
      
      if (!query) {
        aiStatus.textContent = 'Введите вопрос';
        return;
      }

      if (pdfFiles.length === 0) {
        aiStatus.innerHTML = '<span class="ai-error">Пожалуйста, загрузите документы</span>';
        return;
      }

      aiStatus.innerHTML = '<span class="ai-loading">Анализирую документы</span>';
      
      try {
        const fileCount = pdfFiles.length;
        const maxContextSize = 20000;
        const maxCharsPerFile = Math.max(800, Math.floor((maxContextSize * 0.8) / (fileCount || 1)));
        
        let documentContext = pdfFiles
          .map(pdf => {
            const text = pdf.text.length > maxCharsPerFile 
              ? pdf.text.substring(0, maxCharsPerFile) + '...[обрезано]' 
              : pdf.text;
            return `[${pdf.name}]\n${text}`;
          })
          .join('\n\n---\n\n');
        if (documentContext.length > maxContextSize) {
          documentContext = 'Список всех документов:\n' + 
            pdfFiles.map(pdf => `- ${pdf.name}`).join('\n') + 
            '\n\n' + documentContext.substring(0, maxContextSize - 500) + '...[контекст обрезан]';
        }

        console.log(`Отправляю ${fileCount} документов (${documentContext.length} символов контекста)...`);
        const systemPrompt = `Ты - ассистент для поиска информации в документах. 
ВАЖНО: Ты ДОЛЖЕН отвечать ТОЛЬКО на основе предоставленных документов. 
Если информация не содержится в документах, ОБЯЗАТЕЛЬНО скажи: "Информация не найдена в загруженных документах."
Не придумывай и не фантазируй данные.

ПРАВИЛА ОТВЕТА:
- Упоминай ТОЛЬКО документы, в которых НАЙДЕНА искомая информация
- НЕ упоминай документы, где информация отсутствует
- Если информация найдена только в нескольких документах из всех предоставленных - это нормально, просто приведи эти результаты
- Всегда указывай источник информации в квадратных скобках [Название_файла]

ФОРМАТИРОВАНИЕ ОТВЕТА:
- Используй четкую структуру с заголовками (### Заголовок раздела)
- Используй списки для перечисления пунктов (- пункт)
- Выделяй важные термины **жирным шрифтом**
- Используй короткие абзацы для лучшей читаемости
- Если ответ длинный, разбей его на логические секции`;

        const requestBody = {
          model: 'llama-3.3-70b-versatile',
          messages: [
            {
              role: 'system',
              content: systemPrompt
            },
            {
              role: 'user',
              content: `Документы:\n\n${documentContext}\n\nВопрос: ${query}`
            }
          ],
          temperature: 0.3,
          max_tokens: 1024,
        };

        console.log('Отправляю запрос к Groq API...');
        
        const response = await fetch(GROQ_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        const responseText = await response.text();
        console.log('Ответ API:', response.status, responseText);

        if (!response.ok) {
          let errorMsg = `Ошибка API: ${response.status}`;
          try {
            const errorData = JSON.parse(responseText);
            if (errorData.error) {
              errorMsg += ` - ${errorData.error.message || errorData.error}`;
            }
          } catch (e) {
            errorMsg += ` - ${responseText}`;
          }
          throw new Error(errorMsg);
        }

        const data = JSON.parse(responseText);
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
          throw new Error('Неожиданный формат ответа API');
        }

        const answer = data.choices[0].message.content;
        resultsContainer.innerHTML = '';
        const resultDiv = document.createElement('div');
        resultDiv.className = 'result-item ai-result';
        resultDiv.innerHTML = `
          <div class="result-file">🧠 Умный поиск</div>
          <div class="result-text" style="margin-top: 12px;">${formatMarkdown(answer)}</div>
        `;
        resultsContainer.appendChild(resultDiv);
        
        aiStatus.innerHTML = '<span style="color: var(--accent);">✓ Готово</span>';
        setTimeout(() => { aiStatus.textContent = ''; }, 3000);

      } catch (error) {
        console.error('AI Search Error:', error);
        aiStatus.innerHTML = `<span class="ai-error">❌ ${escapeHtml(error.message)}</span>`;
      }
    }

    async function extractTextFromPDF(file) {
      const reader = new FileReader();
      const data = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });

      const pdf = await pdfjsLib.getDocument({ data }).promise;
      let fullText = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + '\n';
      }

      return fullText;
    }

    function findKeywordWithContext(text, query) {
      const safe = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(.{0,60})(${safe})(.{0,60})`, 'gi');
      const matches = [];
      let match;
      while ((match = regex.exec(text)) !== null) {
        matches.push(match[0]);
      }
      return matches;
    }

    function highlightKeyword(text, query) {
      const safe = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${safe})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function formatMarkdown(text) {
      let html = escapeHtml(text);
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h4>$1</h4>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/\[([^\]]+\.pdf)\]/g, '<strong style="color: var(--accent);">[$1]</strong>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      html = html.replace(/<\/li>\n<li>/g, '</li>\n<li>');
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
      html = html.replace(/\n\n/g, '</p><p>');
      html = '<p>' + html + '</p>';
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>(<h[34]>)/g, '$1');
      html = html.replace(/(<\/h[34]>)<\/p>/g, '$1');
      html = html.replace(/<p>(<ul>)/g, '$1');
      html = html.replace(/(<\/ul>)<\/p>/g, '$1');
      
      return html;
    }
  </script>
</body>
</html>
